<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ICD-10 Skin Pathology Tool v1.3.2</title>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: 2rem auto; padding: 1rem; }
    input, select { width: 100%; padding: 0.5rem; font-size: 1.1rem; margin-top: 0.5rem; }
    ul { list-style: none; padding: 0; }
    li { padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .entry { display: flex; justify-content: space-between; align-items: center; }
    .text { flex: 1; }
    button.copy-btn { margin-left: 8px; padding: 4px 8px; font-size: 0.9rem; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    #suggestion { color: gray; margin-top: 0.5rem; font-style: italic; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ICD-10 Skin Pathology Search (v1.3.2)</h1>

  <div class="topbar">
    <label for="mode">Enter â†µ to copy:</label>
    <select id="mode">
      <option value="diagnosis">Diagnosis</option>
      <option value="icd">ICD Code</option>
    </select>
  </div>

  <input id="search" placeholder="e.g., bcc nodular nose or scc ka hand..." autocomplete="off" />
  <div id="suggestion"></div>
  <ul id="results"></ul>

  <script>
    let aliasMap = {};
    let locationMap = {};
    let icdData = [];

    function normalize(text) {
      return text.toLowerCase().trim();
    }

    function titleCase(text) {
      return text.split(' ').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join(' ');
    }

    function fuzzyMatch(input, target) {
      return target.toLowerCase().includes(input.toLowerCase());
    }

    function searchICD(input) {
      const parts = input.toLowerCase().split(/[,;\s]+/);
      let searchTokens = [];

      for (let p of parts) {
        if (aliasMap[p]) searchTokens.push(aliasMap[p].toLowerCase());
        else if (locationMap[p]) searchTokens.push(locationMap[p].toLowerCase());
        else searchTokens.push(p);
      }

      return icdData.filter(entry => {
        const combined = (entry.name + " " + (entry.keywords || []).join(" ")).toLowerCase();
        return searchTokens.every(token => combined.includes(token));
      });
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        console.log("Copied:", text);
      });
    }

    function showResults(matches) {
      const ul = document.getElementById("results");
      ul.innerHTML = "";
      matches.forEach(m => {
        const li = document.createElement("li");
        const container = document.createElement("div");
        container.className = "entry";

        const text = document.createElement("div");
        text.className = "text";
        text.textContent = titleCase(m.name) + " â†’ " + m.code;

        const copyDiagnosis = document.createElement("button");
        copyDiagnosis.className = "copy-btn";
        copyDiagnosis.textContent = "ðŸ“‹ Diagnosis";
        copyDiagnosis.onclick = () => copyText(titleCase(m.name.replace(/ of .+$/, '').trim()));

        const copyICD = document.createElement("button");
        copyICD.className = "copy-btn";
        copyICD.textContent = "ðŸ“Ž ICD Code";
        copyICD.onclick = () => copyText(m.code);

        container.appendChild(text);
        container.appendChild(copyDiagnosis);
        container.appendChild(copyICD);
        li.appendChild(container);
        ul.appendChild(li);
      });
    }

    function updateSuggestion(input) {
      const suggestionBox = document.getElementById("suggestion");
      const keys = Object.keys(aliasMap);
      const guess = keys.find(k => k.includes(input.toLowerCase()));
      if (guess && guess !== input.toLowerCase()) {
        suggestionBox.innerHTML = `Did you mean: <strong>${guess}</strong>? Click to use.`;
        suggestionBox.onclick = () => {
          document.getElementById("search").value = guess;
          updateSearch();
        };
      } else {
        suggestionBox.innerHTML = "";
      }
    }

    function updateSearch() {
      const input = document.getElementById("search").value;
      const results = searchICD(input);
      showResults(results);
      updateSuggestion(input);
    }

    document.getElementById("search").addEventListener("input", updateSearch);

    document.getElementById("search").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const input = document.getElementById("search").value;
        const results = searchICD(input);
        const mode = document.getElementById("mode").value;
        if (results.length > 0) {
          const item = results[0];
          if (mode === "diagnosis") copyText(titleCase(item.name));
          else if (mode === "icd") copyText(item.code);
        }
      }
    });

    async function loadData() {
      aliasMap = await fetch('alias_map_skinpathology.json').then(res => res.json());
      locationMap = await fetch('location_map_skinpathology.json').then(res => res.json());
      icdData = await fetch('icd10_skin_shortlist.json').then(res => res.json());
    }

    loadData().then(updateSearch);
  </script>
</body>
</html>
