<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICD-10 Skin Pathology Search (v1.3)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    input, select, button { font-size: 1rem; margin: 0.5rem; padding: 0.5rem; }
    #result { margin-top: 1rem; }
    #suggestion { color: gray; margin-top: 0.5rem; font-style: italic; cursor: pointer; }
    #autocomplete-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; margin-top: 5px; background: #fff; text-align: left; position: absolute; left: 50%; transform: translateX(-50%); width: 300px; }
    .autocomplete-item { padding: 5px; cursor: pointer; }
    .autocomplete-item:hover { background: #eee; }
  </style>
</head>
<body>
  <h1>ICD-10 Skin Pathology Search (v1.3)</h1>

  <label for="copyMode">Enter â†µ to copy:</label>
  <select id="copyMode">
    <option value="diagnosis">Diagnosis</option>
    <option value="code">ICD Code</option>
  </select><br>

  <input type="text" id="inputBox" placeholder="Enter diagnosis or location..." size="50"><br>

  <button onclick="copyText('diagnosis')">ðŸ“‹ Diagnosis</button>
  <button onclick="copyText('code')">ðŸ“‹ ICD Code</button>

  <div id="suggestion"></div>
  <div id="autocomplete-list"></div>
  <div id="result"></div>

  <script type="module">
    import { searchICD } from './searchICD.js';
    import aliasMap from './alias_map_skinpathology.json' assert { type: 'json' };
    import icdList from './icd_list.json' assert { type: 'json' };

    const inputBox = document.getElementById('inputBox');
    const resultBox = document.getElementById('result');
    const suggestionBox = document.getElementById('suggestion');
    const copyMode = document.getElementById('copyMode');
    const autocompleteList = document.getElementById('autocomplete-list');

    function displayResults(results) {
      resultBox.innerHTML = '';
      for (const res of results) {
        const div = document.createElement('div');
        div.textContent = `${res.diagnosis} â†’ ${res.code}`;
        resultBox.appendChild(div);
      }
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w+/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
    }

    function copyText(type) {
      const results = searchICD(inputBox.value);
      const values = results.map(res => type === 'code' ? res.code : capitalizeWords(res.diagnosis));
      const output = values.join('; ');
      navigator.clipboard.writeText(output).then(() => {
        alert(`${type === 'code' ? 'ICD codes' : 'Diagnosis'} copied to clipboard!`);
      });
    }

    function updateAutocomplete(input) {
      autocompleteList.innerHTML = '';
      const cleanInput = input.toLowerCase();
      if (!cleanInput) return;

      const suggestions = icdList.filter(entry => entry.diagnosis.toLowerCase().includes(cleanInput));
      for (const s of suggestions.slice(0, 10)) {
        const item = document.createElement('div');
        item.textContent = s.diagnosis;
        item.classList.add('autocomplete-item');
        item.onclick = () => {
          inputBox.value = s.diagnosis;
          updateSearch();
          autocompleteList.innerHTML = '';
        };
        autocompleteList.appendChild(item);
      }
    }

    function updateSearch() {
      const inputVal = inputBox.value;
      const results = searchICD(inputVal);
      displayResults(results);

      const firstResult = results[0];
      if (firstResult && firstResult.code === 'Not Found') {
        const suggestion = Object.keys(aliasMap).find(k => k.includes(inputVal.toLowerCase()));
        if (suggestion) {
          suggestionBox.innerHTML = `Did you mean: <strong>${suggestion}</strong>? Click to use.`;
          suggestionBox.onclick = () => {
            inputBox.value = suggestion;
            updateSearch();
          };
        } else {
          suggestionBox.innerHTML = '';
        }
      } else {
        suggestionBox.innerHTML = '';
      }

      updateAutocomplete(inputVal);
    }

    inputBox.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const target = copyMode.value;
        copyText(target);
        autocompleteList.innerHTML = '';
      }
    });

    inputBox.addEventListener('input', () => {
      updateSearch();
    });
  </script>
</body>
</html>
